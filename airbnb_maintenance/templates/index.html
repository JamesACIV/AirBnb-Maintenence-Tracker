<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airbnb Maintenance Tracker</title>
    <style>
        :root {
            --bg: #f6f7f9;
            --surface: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            --accent: #111827;
            --accent-weak: #374151;
            --danger: #b91c1c;
            --ok: #047857;
            --warn: #b45309;
            --radius: 10px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.1rem; letter-spacing: 0.2px; }

        .nav {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 1.25rem;
            display: flex;
            gap: 0.25rem;
            overflow-x: auto;
        }
        .nav button {
            background: none;
            border: none;
            padding: 0.9rem 0.9rem;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--muted);
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        .nav button:hover { color: var(--text); }
        .nav button.active { color: var(--text); border-bottom-color: var(--accent); font-weight: 600; }

        .main { padding: 1.25rem; max-width: 1100px; margin: 0 auto; }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .card h2 { margin-bottom: 0.75rem; font-size: 1rem; }

        .btn {
            background: var(--accent);
            color: var(--surface);
            border: 1px solid var(--accent);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn:hover { background: var(--accent-weak); border-color: var(--accent-weak); }
        .btn.secondary { background: transparent; color: var(--text); border-color: var(--border); }
        .btn.secondary:hover { background: #f3f4f6; border-color: #d1d5db; }
        .btn.danger { background: var(--danger); border-color: var(--danger); }
        .btn.danger:hover { background: #991b1b; border-color: #991b1b; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.65rem; text-align: left; border-bottom: 1px solid var(--border); font-size: 0.95rem; }
        th { color: var(--muted); font-weight: 600; background: #fafafa; }

        .form-group { margin-bottom: 0.85rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: var(--muted); font-size: 0.85rem; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.55rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--surface);
            color: var(--text);
        }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(17, 24, 39, 0.35); padding: 1rem; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); width: 520px; max-width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 12px 30px rgba(0,0,0,0.18); }
        .modal-header { padding: 0.85rem 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1rem; }
        .modal-footer { padding: 0.85rem 1rem; border-top: 1px solid var(--border); text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem; }
        .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; box-shadow: var(--shadow); }
        .stat-card h3 { color: var(--muted); font-size: 0.85rem; margin-bottom: 0.35rem; font-weight: 600; }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: var(--text); }
        .stat-card.paid .value { color: var(--ok); }
        .stat-card.unpaid .value { color: var(--warn); }
        
        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .badge.complete { background: #ecfdf5; color: #065f46; }
        .badge.incomplete { background: #fff7ed; color: #9a3412; }
        .badge.paid { background: #ecfdf5; color: #065f46; }
        .badge.unpaid { background: #fff7ed; color: #9a3412; }
        
        .empty { text-align: center; padding: 1.25rem; color: var(--muted); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .toasts {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 9999;
            max-width: min(420px, calc(100vw - 2rem));
        }

        .toast {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
            padding: 0.75rem 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .toast .msg { color: var(--text); font-size: 0.95rem; line-height: 1.2; }
        .toast .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: flex-end; }
        .toast.success { border-left: 4px solid var(--ok); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--accent-weak); }

        .toast-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.35rem 0.55rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .toast-btn:hover { background: #f3f4f6; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Maintenance Tracker</h1>
        <button class="btn secondary" onclick="logout()">Logout</button>
    </div>
    
    <div class="nav">
        <button class="active" data-tab="dashboard">Dashboard</button>
        <button data-tab="properties">Properties</button>
        <button data-tab="tasks">Tasks</button>
        <button data-tab="contacts">Contacts</button>
    </div>
    
    <div class="main">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card paid">
                    <h3>Total Paid</h3>
                    <div class="value" id="stat-paid">$0</div>
                </div>
                <div class="stat-card unpaid">
                    <h3>Total Unpaid</h3>
                    <div class="value" id="stat-unpaid">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Cost</h3>
                    <div class="value" id="stat-total">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Yearly Projection</h3>
                    <div class="value" id="stat-projection">$0</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 1rem;">
                <h2>Payments Due</h2>
                <div id="tasks-coming-up"></div>
            </div>
        </div>
        
        <!-- Properties Tab -->
        <div id="properties" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Properties</h2>
                    <button class="btn" onclick="openModal('property')">Add Property</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="properties-list"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Tasks</h2>
                    <button class="btn" onclick="openModal('task')">Add Task</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Property</th>
                            <th>Contact</th>
                            <th>When</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-list"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Contacts Tab -->
        <div id="contacts" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Contacts</h2>
                    <button class="btn" onclick="openModal('contact')">Add Contact</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Service</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast-root" class="toasts" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Property Modal -->
    <div id="property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="property-modal-title">Add Property</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('property')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="property-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="property-name">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="property-address">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="property-status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('property')">Cancel</button>
                <button class="btn" onclick="saveProperty(this)">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="task-modal-title">Add Task</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('task')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label>Property</label>
                    <select id="task-property"></select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="task-description">
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <select id="task-contact"></select>
                </div>
                <div class="form-group">
                    <label>Cost</label>
                    <input type="number" step="0.01" id="task-cost">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="task-start-date">
                </div>
                <div class="form-group">
                    <label>Start Time (Optional)</label>
                    <input type="time" id="task-start-time">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="task-end-date">
                </div>
                <div class="form-group">
                    <label>End Time (Optional)</label>
                    <input type="time" id="task-end-time">
                </div>
                <div class="form-group">
                    <label>Recurring</label>
                    <select id="task-recurring">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group" id="interval-group" style="display:none;">
                    <label>Interval</label>
                    <select id="task-interval">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="task-completion">
                        <option value="incomplete">Incomplete</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment</label>
                    <select id="task-payment">
                        <option value="unpaid">Unpaid</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="task-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('task')">Cancel</button>
                <button class="btn" onclick="saveTask(this)">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contact-modal-title">Add Contact</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('contact')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contact-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="contact-name">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="contact-company">
                </div>
                <div class="form-group">
                    <label>Service Type</label>
                    <input type="text" id="contact-service">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="contact-phone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="contact-email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('contact')">Cancel</button>
                <button class="btn" onclick="saveContact(this)">Save</button>
            </div>
        </div>
    </div>

    <script>
        const API = window.location.origin + '/api';

        const toastRoot = document.getElementById('toast-root');

        function showToast(message, type = 'info', options = {}) {
            const { timeoutMs = 2500, actions = [] } = options;

            const el = document.createElement('div');
            el.className = `toast ${type}`;

            const msg = document.createElement('div');
            msg.className = 'msg';
            msg.textContent = message;

            const actionsWrap = document.createElement('div');
            actionsWrap.className = 'actions';

            for (const action of actions) {
                const b = document.createElement('button');
                b.className = 'toast-btn';
                b.textContent = action.label;
                b.onclick = async () => {
                    try {
                        await action.onClick();
                    } finally {
                        el.remove();
                    }
                };
                actionsWrap.appendChild(b);
            }

            el.appendChild(msg);
            if (actions.length) el.appendChild(actionsWrap);
            toastRoot.appendChild(el);

            if (timeoutMs) {
                setTimeout(() => {
                    if (el.isConnected) el.remove();
                }, timeoutMs);
            }
        }

        function setButtonBusy(btn, busy, busyText) {
            if (!btn) return;
            if (busy) {
                btn.dataset._prevText = btn.textContent;
                btn.textContent = busyText || 'Working...';
                btn.disabled = true;
                btn.style.opacity = '0.75';
                btn.style.cursor = 'not-allowed';
            } else {
                btn.textContent = btn.dataset._prevText || btn.textContent;
                btn.disabled = false;
                btn.style.opacity = '';
                btn.style.cursor = '';
                delete btn.dataset._prevText;
            }
        }

        async function apiJson(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...(options.headers || {})
                }
            });
            let data = null;
            try {
                data = await res.json();
            } catch (e) {
                // ignore
            }
            if (!res.ok) {
                const msg = (data && (data.error || data.message)) || `Request failed (${res.status})`;
                throw new Error(msg);
            }
            return data;
        }

        function showUndoToast(message, onUndo) {
            let undone = false;
            const timer = setTimeout(() => {
                // after timeout, toast disappears automatically
            }, 5000);

            showToast(message, 'info', {
                timeoutMs: 5000,
                actions: [
                    {
                        label: 'Undo',
                        onClick: async () => {
                            if (undone) return;
                            undone = true;
                            clearTimeout(timer);
                            await onUndo();
                        }
                    }
                ]
            });
        }
        
        // Check auth on load
        async function checkAuth() {
            try {
                const res = await fetch(API + '/auth/me');
                const data = await res.json();
                if (!data.user) {
                    window.location.href = '/login';
                }
            } catch (e) {
                window.location.href = '/login';
            }
        }
        checkAuth();
        
        async function logout() {
            try {
                await fetch(API + '/auth/logout', {method: 'POST'});
            } catch (e) {}
            window.location.replace('/login');
        }
        
        // Tab navigation
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                loadTab(btn.dataset.tab);
            });
        });
        
        async function loadTab(tab) {
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'properties') loadProperties();
            if (tab === 'tasks') loadTasks();
            if (tab === 'contacts') loadContacts();
        }
        
        // Dashboard
        async function loadDashboard() {
            let summary;
            let projection;
            let unpaidTasks;
            let props;
            try {
                [summary, projection, unpaidTasks, props] = await Promise.all([
                    apiJson(`${API}/reports/summary`),
                    apiJson(`${API}/reports/projection`),
                    apiJson(`${API}/tasks?status=unpaid`),
                    apiJson(`${API}/properties`)
                ]);
            } catch (e) {
                showToast(e.message || 'Failed to load dashboard', 'error');
                return;
            }

            document.getElementById('stat-paid').textContent = `$${(summary.paid || 0).toFixed(2)}`;
            document.getElementById('stat-unpaid').textContent = `$${(summary.unpaid || 0).toFixed(2)}`;
            document.getElementById('stat-total').textContent = `$${(summary.total || 0).toFixed(2)}`;
            document.getElementById('stat-projection').textContent = `$${(projection.yearly_projection || 0).toFixed(2)}`;

            const propMap = Object.fromEntries((props || []).map(p => [p.id, p.name]));

            const normalizeDate = (dateStr) => {
                if (!dateStr) return null;
                const d = new Date(dateStr);
                return isNaN(d) ? null : d;
            };

            const getDaysUntil = (dateStr) => {
                const d = normalizeDate(dateStr);
                if (!d) return '-';
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                d.setHours(0, 0, 0, 0);
                const diff = Math.ceil((d - today) / (1000 * 60 * 60 * 24));
                if (diff < 0) return `${Math.abs(diff)}d overdue`;
                if (diff === 0) return 'Today';
                if (diff === 1) return 'Tomorrow';
                return `${diff}d`;
            };

            // Sort by due date (end_date preferred), earliest first
            (unpaidTasks || []).sort((a, b) => {
                const da = normalizeDate(a.end_date) || normalizeDate(a.start_date) || new Date('9999-12-31');
                const db = normalizeDate(b.end_date) || normalizeDate(b.start_date) || new Date('9999-12-31');
                return da - db;
            });

            const dueSoon = (unpaidTasks || []).slice(0, 10);

            let html = '<table><tr><th>Task</th><th>Property</th><th>Pay In</th><th>Cost</th></tr>';
            if (dueSoon.length === 0) {
                html = '<div class="empty">No unpaid tasks</div>';
            } else {
                for (const t of dueSoon) {
                    const dueDate = t.end_date || t.start_date;
                    html += `<tr>
                        <td>${t.description}</td>
                        <td>${propMap[t.property_id] || '-'}</td>
                        <td>${getDaysUntil(dueDate)}</td>
                        <td>$${(t.cost || 0).toFixed(2)}</td>
                    </tr>`;
                }
                html += '</table>';
            }

            document.getElementById('tasks-coming-up').innerHTML = html;
        }
        
        // Properties
        async function loadProperties() {
            const props = await apiJson(`${API}/properties`);
            const tbody = document.getElementById('properties-list');
            if (props.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty">No properties yet</td></tr>';
                return;
            }
            tbody.innerHTML = props.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.address}</td>
                    <td><span class="badge ${p.status}">${p.status}</span></td>
                    <td>
                        <button class="btn" onclick="editProperty(${p.id}, '${p.name}', '${p.address}', '${p.status}')">Edit</button>
                        <button class="btn danger" onclick="deleteProperty(${p.id}, this)">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editProperty(id, name, address, status) {
            document.getElementById('property-id').value = id;
            document.getElementById('property-name').value = name;
            document.getElementById('property-address').value = address;
            document.getElementById('property-status').value = status;
            document.getElementById('property-modal-title').textContent = 'Edit Property';
            document.getElementById('property-modal').classList.add('active');
        }
        
        async function saveProperty(btn) {
            setButtonBusy(btn, true, 'Saving...');
            const id = document.getElementById('property-id').value;
            const data = {
                name: document.getElementById('property-name').value,
                address: document.getElementById('property-address').value,
                status: document.getElementById('property-status').value
            };

            try {
                if (id) {
                    await apiJson(`${API}/properties/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await apiJson(`${API}/properties`, { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal('property');
                await loadProperties();
                showToast('Property saved', 'success');
            } catch (e) {
                showToast(e.message || 'Failed to save property', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }

        async function deleteProperty(id, btn) {
            if (!confirm('Delete this property?')) return;
            setButtonBusy(btn, true, 'Deleting...');
            try {
                const snapshot = await apiJson(`${API}/properties/${id}`);
                await apiJson(`${API}/properties/${id}`, { method: 'DELETE' });
                await loadProperties();
                showUndoToast('Property deleted', async () => {
                    try {
                        await apiJson(`${API}/properties`, { method: 'POST', body: JSON.stringify({
                            name: snapshot.name,
                            address: snapshot.address,
                            status: snapshot.status
                        })});
                        await loadProperties();
                        showToast('Undo complete', 'success');
                    } catch (e) {
                        showToast(e.message || 'Undo failed', 'error');
                    }
                });
            } catch (e) {
                showToast(e.message || 'Delete failed', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }
        
        // Tasks
        async function loadTasks() {
            const [tasks, props, contacts] = await Promise.all([
                apiJson(`${API}/tasks`),
                apiJson(`${API}/properties`),
                apiJson(`${API}/contacts`)
            ]);
            
            const propMap = Object.fromEntries(props.map(p => [p.id, p.name]));
            const contactMap = Object.fromEntries(contacts.map(c => [c.id, c.name]));

            const formatWhen = (t) => {
                const start = [t.start_date, t.start_time].filter(Boolean).join(' ');
                const end = [t.end_date, t.end_time].filter(Boolean).join(' ');
                if (start && end) return `${start} -> ${end}`;
                return start || end || '-';
            };
            
            const tbody = document.getElementById('tasks-list');
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty">No tasks yet</td></tr>';
                return;
            }
            tbody.innerHTML = tasks.map(t => `
                <tr>
                    <td>${t.description}</td>
                    <td>${propMap[t.property_id] || '-'}</td>
                    <td>${contactMap[t.contact_id] || '-'}</td>
                    <td>${formatWhen(t)}</td>
                    <td>$${t.cost.toFixed(2)}</td>
                    <td><span class="badge ${t.completion_status}">${t.completion_status}</span></td>
                    <td><span class="badge ${t.payment_status}">${t.payment_status}</span></td>
                    <td>
                        <button class="btn" onclick="editTask(${t.id})">Edit</button>
                        <button class="btn danger" onclick="deleteTask(${t.id}, this)">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            // Populate dropdowns
            document.getElementById('task-property').innerHTML = props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        async function editTask(id) {
            const [task, props, contacts] = await Promise.all([
                apiJson(`${API}/tasks/${id}`),
                apiJson(`${API}/properties`),
                apiJson(`${API}/contacts`)
            ]);
            
            document.getElementById('task-property').innerHTML = props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-property').value = task.property_id || '';
            document.getElementById('task-description').value = task.description;
            document.getElementById('task-contact').value = task.contact_id || '';
            document.getElementById('task-cost').value = task.cost;
            document.getElementById('task-start-date').value = task.start_date;
            document.getElementById('task-start-time').value = task.start_time || '';
            document.getElementById('task-end-date').value = task.end_date;
            document.getElementById('task-end-time').value = task.end_time || '';
            document.getElementById('task-recurring').value = task.recurring;
            document.getElementById('task-interval').value = task.recurrence_interval || 'monthly';
            document.getElementById('task-completion').value = task.completion_status;
            document.getElementById('task-payment').value = task.payment_status;
            document.getElementById('task-notes').value = task.notes || '';
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-modal').classList.add('active');
            toggleInterval();
        }
        
        async function saveTask(btn) {
            setButtonBusy(btn, true, 'Saving...');
            const id = document.getElementById('task-id').value;
            const data = {
                property_id: document.getElementById('task-property').value || null,
                contact_id: document.getElementById('task-contact').value || null,
                description: document.getElementById('task-description').value,
                cost: parseFloat(document.getElementById('task-cost').value) || 0,
                start_date: document.getElementById('task-start-date').value,
                start_time: document.getElementById('task-start-time').value,
                end_date: document.getElementById('task-end-date').value,
                end_time: document.getElementById('task-end-time').value,
                recurring: document.getElementById('task-recurring').value,
                recurrence_interval: document.getElementById('task-interval').value,
                completion_status: document.getElementById('task-completion').value,
                payment_status: document.getElementById('task-payment').value,
                notes: document.getElementById('task-notes').value
            };

            try {
                if (id) {
                    await apiJson(`${API}/tasks/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await apiJson(`${API}/tasks`, { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal('task');
                await loadTasks();
                showToast('Task saved', 'success');
            } catch (e) {
                showToast(e.message || 'Failed to save task', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }

        async function deleteTask(id, btn) {
            if (!confirm('Delete this task?')) return;
            setButtonBusy(btn, true, 'Deleting...');
            try {
                const snapshot = await apiJson(`${API}/tasks/${id}`);
                await apiJson(`${API}/tasks/${id}`, { method: 'DELETE' });
                await loadTasks();
                showUndoToast('Task deleted', async () => {
                    try {
                        const copy = { ...snapshot };
                        delete copy.id;
                        await apiJson(`${API}/tasks`, { method: 'POST', body: JSON.stringify(copy) });
                        await loadTasks();
                        showToast('Undo complete', 'success');
                    } catch (e) {
                        showToast(e.message || 'Undo failed', 'error');
                    }
                });
            } catch (e) {
                showToast(e.message || 'Delete failed', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }
        
        // Contacts
        async function loadContacts() {
            const contacts = await apiJson(`${API}/contacts`);
            const tbody = document.getElementById('contacts-list');
            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No contacts yet</td></tr>';
                return;
            }
            tbody.innerHTML = contacts.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.company || '-'}</td>
                    <td>${c.service_type || '-'}</td>
                    <td>${c.phone || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>
                        <button class="btn" onclick="editContact(${c.id})">Edit</button>
                        <button class="btn danger" onclick="deleteContact(${c.id}, this)">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function editContact(id) {
            const contact = await apiJson(`${API}/contacts/${id}`);
            document.getElementById('contact-id').value = contact.id;
            document.getElementById('contact-name').value = contact.name;
            document.getElementById('contact-company').value = contact.company || '';
            document.getElementById('contact-service').value = contact.service_type || '';
            document.getElementById('contact-phone').value = contact.phone || '';
            document.getElementById('contact-email').value = contact.email || '';
            document.getElementById('contact-modal-title').textContent = 'Edit Contact';
            document.getElementById('contact-modal').classList.add('active');
        }
        
        async function saveContact(btn) {
            setButtonBusy(btn, true, 'Saving...');
            const id = document.getElementById('contact-id').value;
            const data = {
                name: document.getElementById('contact-name').value,
                company: document.getElementById('contact-company').value,
                service_type: document.getElementById('contact-service').value,
                phone: document.getElementById('contact-phone').value,
                email: document.getElementById('contact-email').value
            };

            try {
                if (id) {
                    await apiJson(`${API}/contacts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await apiJson(`${API}/contacts`, { method: 'POST', body: JSON.stringify(data) });
                }
                closeModal('contact');
                await loadContacts();
                showToast('Contact saved', 'success');
            } catch (e) {
                showToast(e.message || 'Failed to save contact', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }
        
        async function deleteContact(id, btn) {
            if (!confirm('Delete this contact?')) return;
            setButtonBusy(btn, true, 'Deleting...');
            try {
                const snapshot = await apiJson(`${API}/contacts/${id}`);
                await apiJson(`${API}/contacts/${id}`, { method: 'DELETE' });
                await loadContacts();
                showUndoToast('Contact deleted', async () => {
                    try {
                        const copy = { ...snapshot };
                        delete copy.id;
                        await apiJson(`${API}/contacts`, { method: 'POST', body: JSON.stringify(copy) });
                        await loadContacts();
                        showToast('Undo complete', 'success');
                    } catch (e) {
                        showToast(e.message || 'Undo failed', 'error');
                    }
                });
            } catch (e) {
                showToast(e.message || 'Delete failed', 'error');
            } finally {
                setButtonBusy(btn, false);
            }
        }
        
        // Modal helpers
        async function openModal(type) {
            document.getElementById(`${type}-id`).value = '';
            document.querySelectorAll(`#${type}-modal input, #${type}-modal select, #${type}-modal textarea`).forEach(el => el.value = '');
            if (type === 'task') {
                try {
                    // Load properties and contacts for dropdowns
                    const [propsRes, contactsRes] = await Promise.all([
                        fetch(`${API}/properties`),
                        fetch(`${API}/contacts`)
                    ]);
                    
                    if (!propsRes.ok || !contactsRes.ok) {
                        alert('Please log in again');
                        window.location.href = '/login';
                        return;
                    }
                    
                    const props = await propsRes.json();
                    const contacts = await contactsRes.json();
                    
                    document.getElementById('task-property').innerHTML = '<option value="">Select Property</option>' + props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                } catch (e) {
                    console.error(e);
                    showToast('Error loading data. Please log in again.', 'error');
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('task-recurring').value = 'no';
                toggleInterval();
            }
            document.getElementById(`${type}-modal-title`).textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById(`${type}-modal`).classList.add('active');
        }
        
        function closeModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('active');
        }
        
        function toggleInterval() {
            const recurring = document.getElementById('task-recurring').value;
            document.getElementById('interval-group').style.display = recurring === 'yes' ? 'block' : 'none';
        }
        
        document.getElementById('task-recurring').addEventListener('change', toggleInterval);
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        });
        
        // Initial load
        loadDashboard();
    </script>
</body>
</html>
