<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airbnb Maintenance Tracker</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: #ff5a5f; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.5rem; }
        
        .nav { background: white; border-bottom: 1px solid #ddd; padding: 0 2rem; }
        .nav button { background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-size: 1rem; color: #666; border-bottom: 3px solid transparent; }
        .nav button:hover { color: #ff5a5f; }
        .nav button.active { color: #ff5a5f; border-bottom-color: #ff5a5f; font-weight: 600; }
        
        .main { padding: 2rem; max-width: 1200px; margin: 0 auto; }
        
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .card h2 { margin-bottom: 1rem; color: #333; }
        
        .btn { background: #ff5a5f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .btn:hover { background: #e8484d; }
        .btn.secondary { background: #666; }
        .btn.danger { background: #dc3545; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; color: #666; }
        tr:hover { background: #f9f9f9; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; color: #666; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1rem; }
        .modal-footer { padding: 1rem; border-top: 1px solid #eee; text-align: right; }
        
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .stat-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-card h3 { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 2rem; font-weight: bold; color: #333; }
        .stat-card.paid .value { color: #28a745; }
        .stat-card.unpaid .value { color: #dc3545; }
        
        .badge { padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .badge.complete { background: #d4edda; color: #155724; }
        .badge.incomplete { background: #f8d7da; color: #721c24; }
        .badge.paid { background: #d4edda; color: #155724; }
        .badge.unpaid { background: #fff3cd; color: #856404; }
        
        .empty { text-align: center; padding: 2rem; color: #999; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Airbnb Maintenance Tracker</h1>
        <button class="btn" onclick="logout()" style="background: rgba(255,255,255,0.2);">Logout</button>
    </div>
    
    <div class="nav">
        <button class="active" data-tab="dashboard">Dashboard</button>
        <button data-tab="properties">Properties</button>
        <button data-tab="tasks">Tasks</button>
        <button data-tab="contacts">Contacts</button>
    </div>
    
    <div class="main">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-card paid">
                    <h3>Total Paid</h3>
                    <div class="value" id="stat-paid">$0</div>
                </div>
                <div class="stat-card unpaid">
                    <h3>Total Unpaid</h3>
                    <div class="value" id="stat-unpaid">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Total Cost</h3>
                    <div class="value" id="stat-total">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Yearly Projection</h3>
                    <div class="value" id="stat-projection">$0</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 1.5rem;">
                <h2>Monthly Breakdown</h2>
                <div id="monthly-breakdown"></div>
            </div>
        </div>
        
        <!-- Properties Tab -->
        <div id="properties" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Properties</h2>
                    <button class="btn" onclick="openModal('property')">Add Property</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="properties-list"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Tasks</h2>
                    <button class="btn" onclick="openModal('task')">Add Task</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Property</th>
                            <th>Contact</th>
                            <th>Cost</th>
                            <th>Status</th>
                            <th>Payment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-list"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Contacts Tab -->
        <div id="contacts" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Contacts</h2>
                    <button class="btn" onclick="openModal('contact')">Add Contact</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Service</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-list"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Property Modal -->
    <div id="property-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="property-modal-title">Add Property</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('property')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="property-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="property-name">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="property-address">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="property-status">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('property')">Cancel</button>
                <button class="btn" onclick="saveProperty()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="task-modal-title">Add Task</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('task')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label>Property</label>
                    <select id="task-property"></select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="task-description">
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <select id="task-contact"></select>
                </div>
                <div class="form-group">
                    <label>Cost</label>
                    <input type="number" step="0.01" id="task-cost">
                </div>
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="task-start-date">
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    <input type="date" id="task-end-date">
                </div>
                <div class="form-group">
                    <label>Recurring</label>
                    <select id="task-recurring">
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group" id="interval-group" style="display:none;">
                    <label>Interval</label>
                    <select id="task-interval">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="task-completion">
                        <option value="incomplete">Incomplete</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment</label>
                    <select id="task-payment">
                        <option value="unpaid">Unpaid</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="task-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('task')">Cancel</button>
                <button class="btn" onclick="saveTask()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Contact Modal -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="contact-modal-title">Add Contact</h3>
                <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal('contact')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contact-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="contact-name">
                </div>
                <div class="form-group">
                    <label>Company</label>
                    <input type="text" id="contact-company">
                </div>
                <div class="form-group">
                    <label>Service Type</label>
                    <input type="text" id="contact-service">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="contact-phone">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="contact-email">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeModal('contact')">Cancel</button>
                <button class="btn" onclick="saveContact()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Your deployed cloud API URL
        const CLOUD_API_URL = 'https://airbnb-maintenence-tracker.onrender.com/api';
        
        const API = CLOUD_API_URL || 'http://localhost:5000/api';
        
        // Check auth on load
        async function checkAuth() {
            try {
                const res = await fetch(API + '/auth/me');
                const data = await res.json();
                if (!data.user) {
                    window.location.href = '/login';
                }
            } catch (e) {
                window.location.href = '/login';
            }
        }
        checkAuth();
        
        async function logout() {
            try {
                await fetch(API + '/auth/logout', {method: 'POST'});
            } catch (e) {}
            window.location.replace('/login');
        }
        
        // Tab navigation
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                loadTab(btn.dataset.tab);
            });
        });
        
        async function loadTab(tab) {
            if (tab === 'dashboard') loadDashboard();
            if (tab === 'properties') loadProperties();
            if (tab === 'tasks') loadTasks();
            if (tab === 'contacts') loadContacts();
        }
        
        // Dashboard
        async function loadDashboard() {
            const summary = await fetch(`${API}/reports/summary`).then(r => r.json());
            document.getElementById('stat-paid').textContent = `$${summary.paid.toFixed(2)}`;
            document.getElementById('stat-unpaid').textContent = `$${summary.unpaid.toFixed(2)}`;
            document.getElementById('stat-total').textContent = `$${summary.total.toFixed(2)}`;
            
            const projection = await fetch(`${API}/reports/projection`).then(r => r.json());
            document.getElementById('stat-projection').textContent = `$${projection.yearly_projection.toFixed(2)}`;
            
            const monthly = await fetch(`${API}/reports/monthly`).then(r => r.json());
            let html = '<table><tr><th>Property</th><th>Cost</th></tr>';
            for (const [prop, cost] of Object.entries(monthly)) {
                if (prop !== 'total') html += `<tr><td>${prop}</td><td>$${cost.toFixed(2)}</td></tr>`;
            }
            html += `<tr><td><strong>Total</strong></td><td><strong>$${(monthly.total || 0).toFixed(2)}</strong></td></tr></table>`;
            document.getElementById('monthly-breakdown').innerHTML = html;
        }
        
        // Properties
        async function loadProperties() {
            const props = await fetch(`${API}/properties`).then(r => r.json());
            const tbody = document.getElementById('properties-list');
            if (props.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="empty">No properties yet</td></tr>';
                return;
            }
            tbody.innerHTML = props.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.address}</td>
                    <td><span class="badge ${p.status}">${p.status}</span></td>
                    <td>
                        <button class="btn" onclick="editProperty(${p.id}, '${p.name}', '${p.address}', '${p.status}')">Edit</button>
                        <button class="btn danger" onclick="deleteProperty(${p.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function editProperty(id, name, address, status) {
            document.getElementById('property-id').value = id;
            document.getElementById('property-name').value = name;
            document.getElementById('property-address').value = address;
            document.getElementById('property-status').value = status;
            document.getElementById('property-modal-title').textContent = 'Edit Property';
            document.getElementById('property-modal').classList.add('active');
        }
        
        async function saveProperty() {
            const id = document.getElementById('property-id').value;
            const data = {
                name: document.getElementById('property-name').value,
                address: document.getElementById('property-address').value,
                status: document.getElementById('property-status').value
            };
            
            if (id) {
                await fetch(`${API}/properties/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                await fetch(`${API}/properties`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }
            closeModal('property');
            loadProperties();
        }
        
        async function deleteProperty(id) {
            if (confirm('Delete this property?')) {
                await fetch(`${API}/properties/${id}`, {method: 'DELETE'});
                loadProperties();
            }
        }
        
        // Tasks
        async function loadTasks() {
            const [tasks, props, contacts] = await Promise.all([
                fetch(`${API}/tasks`).then(r => r.json()),
                fetch(`${API}/properties`).then(r => r.json()),
                fetch(`${API}/contacts`).then(r => r.json())
            ]);
            
            const propMap = Object.fromEntries(props.map(p => [p.id, p.name]));
            const contactMap = Object.fromEntries(contacts.map(c => [c.id, c.name]));
            
            const tbody = document.getElementById('tasks-list');
            if (tasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No tasks yet</td></tr>';
                return;
            }
            tbody.innerHTML = tasks.map(t => `
                <tr>
                    <td>${t.description}</td>
                    <td>${propMap[t.property_id] || '-'}</td>
                    <td>${contactMap[t.contact_id] || '-'}</td>
                    <td>$${t.cost.toFixed(2)}</td>
                    <td><span class="badge ${t.completion_status}">${t.completion_status}</span></td>
                    <td><span class="badge ${t.payment_status}">${t.payment_status}</span></td>
                    <td>
                        <button class="btn" onclick="editTask(${t.id})">Edit</button>
                        <button class="btn danger" onclick="deleteTask(${t.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            // Populate dropdowns
            document.getElementById('task-property').innerHTML = props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        async function editTask(id) {
            const [task, props, contacts] = await Promise.all([
                fetch(`${API}/tasks/${id}`).then(r => r.json()),
                fetch(`${API}/properties`).then(r => r.json()),
                fetch(`${API}/contacts`).then(r => r.json())
            ]);
            
            document.getElementById('task-property').innerHTML = props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-property').value = task.property_id || '';
            document.getElementById('task-description').value = task.description;
            document.getElementById('task-contact').value = task.contact_id || '';
            document.getElementById('task-cost').value = task.cost;
            document.getElementById('task-start-date').value = task.start_date;
            document.getElementById('task-end-date').value = task.end_date;
            document.getElementById('task-recurring').value = task.recurring;
            document.getElementById('task-interval').value = task.recurrence_interval || 'monthly';
            document.getElementById('task-completion').value = task.completion_status;
            document.getElementById('task-payment').value = task.payment_status;
            document.getElementById('task-notes').value = task.notes || '';
            document.getElementById('task-modal-title').textContent = 'Edit Task';
            document.getElementById('task-modal').classList.add('active');
            toggleInterval();
        }
        
        async function saveTask() {
            const id = document.getElementById('task-id').value;
            const data = {
                property_id: document.getElementById('task-property').value || null,
                contact_id: document.getElementById('task-contact').value || null,
                description: document.getElementById('task-description').value,
                cost: parseFloat(document.getElementById('task-cost').value) || 0,
                start_date: document.getElementById('task-start-date').value,
                end_date: document.getElementById('task-end-date').value,
                recurring: document.getElementById('task-recurring').value,
                recurrence_interval: document.getElementById('task-interval').value,
                completion_status: document.getElementById('task-completion').value,
                payment_status: document.getElementById('task-payment').value,
                notes: document.getElementById('task-notes').value
            };
            
            if (id) {
                await fetch(`${API}/tasks/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                await fetch(`${API}/tasks`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }
            closeModal('task');
            loadTasks();
        }
        
        async function deleteTask(id) {
            if (confirm('Delete this task?')) {
                await fetch(`${API}/tasks/${id}`, {method: 'DELETE'});
                loadTasks();
            }
        }
        
        // Contacts
        async function loadContacts() {
            const contacts = await fetch(`${API}/contacts`).then(r => r.json());
            const tbody = document.getElementById('contacts-list');
            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No contacts yet</td></tr>';
                return;
            }
            tbody.innerHTML = contacts.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.company || '-'}</td>
                    <td>${c.service_type || '-'}</td>
                    <td>${c.phone || '-'}</td>
                    <td>${c.email || '-'}</td>
                    <td>
                        <button class="btn" onclick="editContact(${c.id})">Edit</button>
                        <button class="btn danger" onclick="deleteContact(${c.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function editContact(id) {
            const contact = await fetch(`${API}/contacts/${id}`).then(r => r.json());
            document.getElementById('contact-id').value = contact.id;
            document.getElementById('contact-name').value = contact.name;
            document.getElementById('contact-company').value = contact.company || '';
            document.getElementById('contact-service').value = contact.service_type || '';
            document.getElementById('contact-phone').value = contact.phone || '';
            document.getElementById('contact-email').value = contact.email || '';
            document.getElementById('contact-modal-title').textContent = 'Edit Contact';
            document.getElementById('contact-modal').classList.add('active');
        }
        
        async function saveContact() {
            const id = document.getElementById('contact-id').value;
            const data = {
                name: document.getElementById('contact-name').value,
                company: document.getElementById('contact-company').value,
                service_type: document.getElementById('contact-service').value,
                phone: document.getElementById('contact-phone').value,
                email: document.getElementById('contact-email').value
            };
            
            if (id) {
                await fetch(`${API}/contacts/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                await fetch(`${API}/contacts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }
            closeModal('contact');
            loadContacts();
        }
        
        async function deleteContact(id) {
            if (confirm('Delete this contact?')) {
                await fetch(`${API}/contacts/${id}`, {method: 'DELETE'});
                loadContacts();
            }
        }
        
        // Modal helpers
        async function openModal(type) {
            document.getElementById(`${type}-id`).value = '';
            document.querySelectorAll(`#${type}-modal input, #${type}-modal select, #${type}-modal textarea`).forEach(el => el.value = '');
            if (type === 'task') {
                try {
                    // Load properties and contacts for dropdowns
                    const [propsRes, contactsRes] = await Promise.all([
                        fetch(`${API}/properties`),
                        fetch(`${API}/contacts`)
                    ]);
                    
                    if (!propsRes.ok || !contactsRes.ok) {
                        alert('Please log in again');
                        window.location.href = '/login';
                        return;
                    }
                    
                    const props = await propsRes.json();
                    const contacts = await contactsRes.json();
                    
                    document.getElementById('task-property').innerHTML = '<option value="">Select Property</option>' + props.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    document.getElementById('task-contact').innerHTML = '<option value="">None</option>' + contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                } catch (e) {
                    console.error(e);
                    alert('Error loading data. Please log in again.');
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('task-recurring').value = 'no';
                toggleInterval();
            }
            document.getElementById(`${type}-modal-title`).textContent = `Add ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            document.getElementById(`${type}-modal`).classList.add('active');
        }
        
        function closeModal(type) {
            document.getElementById(`${type}-modal`).classList.remove('active');
        }
        
        function toggleInterval() {
            const recurring = document.getElementById('task-recurring').value;
            document.getElementById('interval-group').style.display = recurring === 'yes' ? 'block' : 'none';
        }
        
        document.getElementById('task-recurring').addEventListener('change', toggleInterval);
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        });
        
        // Initial load
        loadDashboard();
    </script>
</body>
</html>
